import { NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'

export async function GET() {
  try {
    const companies = await prisma.company.findMany({
      include: {
        experiences: {
          include: {
            media: true,
            homepageMedia: true,
            cardMedia: true,
          },
        },
      },
    })

    const educations = await prisma.education.findMany({
      include: {
        media: true,
      },
    })
    const certifications = await prisma.certification.findMany({
      include: {
        media: true,
      },
    })
    const skills = await prisma.skill.findMany({
      include: {
        media: true,
      },
    })

    const highlights = await prisma.highlight.findMany({
      include: {
        homepageMedia: true,
        cardMedia: true,
        media: true,
      },
      orderBy: {
        startDate: 'desc',
      },
    })

    // Get navbar configuration
    let navbarConfig = await prisma.navbarConfig.findFirst()
    if (!navbarConfig) {
      navbarConfig = await prisma.navbarConfig.create({
        data: {
          logoText: "resumeflex",
          logoImageUrl: null,
          useImageLogo: false,
          workExperienceLabel: "Work Experience",
          careerSeriesLabel: "Career Series",
          educationLabel: "Education",
          certificationsLabel: "Certifications",
          skillsLabel: "Skills",
          backgroundColor: "#141414",
          backgroundType: "color",
          backgroundImageUrl: null,
          gradientFrom: "#141414",
          gradientTo: "#1a1a1a",
          fontFamily: "Inter",
          logoFontFamily: "Inter"
        }
      })
    }

    const singleExperiences = companies.filter((company) => company.experiences.length === 1)
    const seriesExperiences = companies.filter((company) => company.experiences.length > 1)

    return NextResponse.json({
      singleExperiences,
      seriesExperiences,
      educations,
      certifications,
      skills,
      highlights,
      navbarConfig,
    })
  } catch (error) {
    console.error('Failed to fetch data:', error)
    return NextResponse.json({ error: 'Failed to fetch data' }, { status: 500 })
  }
}
